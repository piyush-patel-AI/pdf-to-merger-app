<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-File Merger App</title>
    <!-- Load Tailwind CSS via CDN - Check your PyWebView environment allows external access -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom scrollbar for file list */
        .file-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .file-list-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
        .file-list-container::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Container Card -->
    <div id="app-container" class="w-full max-w-xl bg-white p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-100 transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2 tracking-tight">
            Document Merger
        </h1>
        <p class="text-gray-500 mb-6">
            Upload PDFs and documents for merging. Sequence matters!
        </p>

        <!-- 1. File Upload Area -->
        <div class="mb-6">
            <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">Select Files (PDF, DOCX, etc.)</label>
            <input 
                type="file" 
                id="file-input" 
                multiple 
                accept=".pdf,.doc,.docx" 
                class="hidden"
                onchange="handleFileSelect(event)"
            >
            <div 
                id="drop-area"
                class="border-2 border-dashed border-indigo-300 rounded-xl p-6 text-center cursor-pointer hover:border-indigo-500 transition duration-150 ease-in-out bg-indigo-50"
                onclick="document.getElementById('file-input').click()"
                ondragover="handleDragOver(event)"
                ondragleave="handleDragLeave(event)"
                ondrop="handleDrop(event)"
            >
                <!-- SVG Icon for Drop Area (Visible in your screenshot, proving file load) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-10 w-10 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 012 10.118m-9.5-3.088a2 2 0 100-4.001M10 11a2 2 0 100-4.001m-1.5 8.5h4"/>
                </svg>
                <p class="mt-1 text-sm text-indigo-600 font-semibold">
                    Click to upload or drag & drop files here
                </p>
                <p class="text-xs text-indigo-400">PDFs are prioritized for merging.</p>
            </div>
            <!-- NEW CHECKBOX ADDED HERE -->
            <div class="mt-4">
                <label class="flex items-center text-sm font-medium text-gray-700">
                    <input type="checkbox" id="saveAsPdf" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2"> 
                    Save as PDF
                </label>
            </div>
        </div>

        <!-- 2. Uploaded File List -->
        <div id="file-list-section" class="mb-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Files to Merge (Order):</h3>
            <div id="file-list" class="file-list-container space-y-2 p-3 bg-gray-50 rounded-lg max-h-48 overflow-y-auto border border-gray-200">
                <!-- Files will be inserted here by JavaScript -->
            </div>
        </div>
        
        <!-- 3. Merge Button -->
        <button 
            id="merge-button"
            onclick="handleMergeClick()"
            disabled
            class="w-full py-3 px-4 rounded-xl text-white font-bold text-lg bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-indigo-500/50 transition duration-300 ease-in-out transform hover:scale-[1.01] flex items-center justify-center"
        >
            <span id="button-text">Merge Documents</span>
            <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>

        <!-- 4. Status and Download Area -->
        <div id="status-area" class="mt-6 p-4 rounded-xl hidden" role="alert">
            <div id="status-message" class="text-sm font-medium"></div>
            <div id="download-link-container" class="mt-3 hidden">
                <!-- Download link will be inserted here -->
            </div>
        </div>
    </div>

    <script>
    // --- Global State and Constants ---
    const BASE_URL = ''; // auto-uses same domain (works on localhost + Cloudflare)
    const ENDPOINTS = {
    UPLOAD: `/upload`,
    MERGE: `/merge`,
    GET: `/get`
};


    let uploadedFiles = [];
    let isProcessing = false;

    const fileInput = document.getElementById('file-input');
    const dropArea = document.getElementById('drop-area');
    const fileListSection = document.getElementById('file-list-section');
    const fileList = document.getElementById('file-list');
    const mergeButton = document.getElementById('merge-button');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');
    const statusArea = document.getElementById('status-area');
    const statusMessage = document.getElementById('status-message');
    const downloadLinkContainer = document.getElementById('download-link-container');

    function updateUI() {
        if (uploadedFiles.length > 0) {
            fileListSection.classList.remove('hidden');
            mergeButton.disabled = false;
        } else {
            fileListSection.classList.add('hidden');
            mergeButton.disabled = true;
        }

        fileList.innerHTML = uploadedFiles.map((file, index) => `
            <div class="flex items-center justify-between p-2 bg-white rounded-lg shadow-md border border-gray-100">
                <span class="text-gray-700 truncate text-sm flex-1 mr-4">
                    <span class="font-bold text-indigo-600">${index + 1}.</span> ${file.name} 
                    <span class="text-xs text-gray-400 ml-1">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                </span>
                <div class="flex items-center space-x-1">
                    <button onclick="moveFile(${index}, 'up')" ${index === 0 ? 'disabled' : ''} class="text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-100 transition-colors disabled:opacity-30" aria-label="Move file up">â–²</button>
                    <button onclick="moveFile(${index}, 'down')" ${index === uploadedFiles.length - 1 ? 'disabled' : ''} class="text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-100 transition-colors disabled:opacity-30" aria-label="Move file down">â–¼</button>
                    <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition-colors ml-1" aria-label="Remove file ${file.name}">âœ•</button>
                </div>
            </div>
        `).join('');

        statusArea.classList.add('hidden');
        downloadLinkContainer.classList.add('hidden');
        statusArea.className = 'mt-6 p-4 rounded-xl hidden';
    }

    function moveFile(index, direction) {
        if (isProcessing) return;
        const newIndex = direction === 'up' ? index - 1 : index + 1;
        if (newIndex >= 0 && newIndex < uploadedFiles.length) {
            [uploadedFiles[index], uploadedFiles[newIndex]] = [uploadedFiles[newIndex], uploadedFiles[index]];
            updateUI();
        }
    }

    function setProcessing(processing, step = 'Merging Documents') {
        isProcessing = processing;
        mergeButton.disabled = processing || uploadedFiles.length === 0;
        if (processing) {
            buttonText.textContent = step + '...';
            spinner.classList.remove('hidden');
        } else {
            buttonText.textContent = 'Merge Documents';
            spinner.classList.add('hidden');
        }
    }

    function displayStatus(message, type = 'success') {
        statusArea.classList.remove('hidden');
        statusMessage.textContent = message;
        downloadLinkContainer.classList.add('hidden');
        downloadLinkContainer.innerHTML = '';
        if (type === 'success') {
            statusArea.className = 'mt-6 p-4 rounded-xl bg-green-100 text-green-700 border border-green-300';
        } else if (type === 'error') {
            statusArea.className = 'mt-6 p-4 rounded-xl bg-red-100 text-red-700 border border-red-300';
        } else {
            statusArea.className = 'mt-6 p-4 rounded-xl bg-blue-100 text-blue-700 border border-blue-300';
        }
    }

    function addFiles(fileListObject) {
        const newFiles = Array.from(fileListObject);
        uploadedFiles = [...uploadedFiles, ...newFiles];
        fileInput.value = '';
        updateUI();
    }

    function handleFileSelect(event) { addFiles(event.target.files); }
    function handleDragOver(event) { event.preventDefault(); dropArea.classList.add('bg-indigo-200', 'border-indigo-600'); }
    function handleDragLeave(event) { event.preventDefault(); dropArea.classList.remove('bg-indigo-200', 'border-indigo-600'); }
    function handleDrop(event) { event.preventDefault(); dropArea.classList.remove('bg-indigo-200', 'border-indigo-600'); if (event.dataTransfer.files.length) addFiles(event.dataTransfer.files); }
    function removeFile(index) { uploadedFiles.splice(index, 1); updateUI(); }

    async function uploadFiles() {
        setProcessing(true, 'Uploading Files');
        const formData = new FormData();
        const saveAsPdfChecked = document.getElementById('saveAsPdf').checked;
        formData.append('save_as_pdf', saveAsPdfChecked ? 'true' : 'false');
        uploadedFiles.forEach(file => formData.append('files', file));
        try {
            const response = await fetch(ENDPOINTS.UPLOAD, { method: 'POST', body: formData });
            if (!response.ok) throw new Error(await response.text());
            return await response.json();
        } catch (error) {
            console.error('Upload Error:', error);
            displayStatus(`Upload Error: ${error.message}`, 'error');
            return null;
        }
    }

    /** ðŸ”¥ NEW: Trigger merge and auto-download the resulting file **/
    async function triggerMerge() {
        setProcessing(true, 'Processing Merge');
        try {
            const response = await fetch(ENDPOINTS.MERGE, { method: 'POST' });
            if (!response.ok) throw new Error(await response.text());

            // Browser download
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const cd = response.headers.get('Content-Disposition');
            a.download = cd && cd.includes('filename=') ? cd.split('filename=')[1].replace(/['"]/g, '') : 'merged_document.pdf';
            a.href = url;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            displayStatus('âœ… Merge completed! File downloaded.', 'success');
        } catch (error) {
            console.error('Merge Trigger Error:', error);
            displayStatus(`Merge Operation Error: ${error.message}`, 'error');
        } finally {
            setProcessing(false);
        }
    }

    async function handleMergeClick() {
        if (isProcessing || uploadedFiles.length === 0) return;
        statusArea.classList.add('hidden');
        const uploadResult = await uploadFiles();
        if (!uploadResult) { setProcessing(false); return; }
        await triggerMerge();
    }

    window.onload = updateUI;
</script>

<footer style="
  position: fixed;
  bottom: 10px;
  right: 20px;
  font-family: 'Poppins', sans-serif;
  font-size: 18px;
  color: white;
  background: rgba(0,0,0,0.5);
  padding: 8px 15px;
  border-radius: 10px;
  backdrop-filter: blur(5px);
">
  Made by <b>Piyush Patel</b>
</footer>


</body>
</html>
